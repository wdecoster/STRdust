#!/usr/bin/env bash
set -euo pipefail

echo "[STRdust] Running pre-push checks..."

# Ensure Cargo is available in PATH
if ! command -v cargo >/dev/null 2>&1; then
  if [ -f "$HOME/.cargo/env" ]; then
    # shellcheck disable=SC1090
    . "$HOME/.cargo/env"
  fi
  export PATH="$HOME/.cargo/bin:${PATH:-}"
fi

if ! command -v cargo >/dev/null 2>&1; then
  echo "[STRdust] ❌ Cargo not found in PATH. Ensure Rust is installed and ~/.cargo/bin is on PATH."
  echo "           You can run: make setup"
  exit 1
fi

# Use Makefile target to keep logic in one place
if ! make -s pre-push; then
  echo "[STRdust] ❌ Pre-push checks failed. Fix the issues above and try again."
  exit 1
fi

echo "[STRdust] ✅ Pre-push checks passed."
